<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新用戶驗證系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 200%; }
        }
        .animate-shine {
            animation: shine 1.5s infinite;
        }
        .animate-fadeIn {
            animation: fadeIn 0.4s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ============================================================================
        // --- Firebase 設定 (請在此處填入您的資料) ---
        // ============================================================================

        const isCustomConfig = true; // ★ 設為 true 以使用您的設定

        const myFirebaseConfig = {
            apiKey: "AIzaSyBZpemWzG-OnxKc-AzDVn20nrPGnler8Ho",
            authDomain: "project-6295196669844651558.firebaseapp.com",
            projectId: "project-6295196669844651558",
            storageBucket: "project-6295196669844651558.firebasestorage.app",
            messagingSenderId: "588319438113",
            appId: "1:588319438113:web:b41c7f43b6752723137a60",
            measurementId: "G-ZRJJ0DY8KF"
        };

        // --- 初始化邏輯 ---
        let firebaseConfig = isCustomConfig ? myFirebaseConfig : { apiKey: "demo-mode" };
        let appId = isCustomConfig ? myFirebaseConfig.projectId : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Icons Components (Simple SVG Wrappers) ---
        const Icon = ({ path, className = "", size = 24, fill = "none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Copy: (props) => <Icon {...props} path={<><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>} />,
            Check: (props) => <Icon {...props} path={<path d="M20 6 9 17l-5-5"/>} />,
            RefreshCw: (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} />,
            User: (props) => <Icon {...props} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            MessageSquare: (props) => <Icon {...props} path={<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>} />,
            ShieldCheck: (props) => <Icon {...props} path={<><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="m9 12 2 2 4-4"/></>} />,
            Phone: (props) => <Icon {...props} path={<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>} />,
            Mail: (props) => <Icon {...props} path={<><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></>} />,
            Lock: (props) => <Icon {...props} path={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />,
            LogOut: (props) => <Icon {...props} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />,
            Trash2: (props) => <Icon {...props} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            Search: (props) => <Icon {...props} path={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />,
            AlertCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />,
            Settings: (props) => <Icon {...props} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
        };

        const { useState, useEffect } = React;

        // ============================================================================
        // --- React App ---
        // ============================================================================
        function App() {
            // --- 狀態管理 ---
            const [user, setUser] = useState(null);
            const [view, setView] = useState('user'); // 'user', 'login', 'admin', 'maintenance'
            
            // 系統設定 (維護模式)
            const [maintenance, setMaintenance] = useState({
                enabled: false,
                startTime: '',
                endTime: '',
                message: '系統正在進行例行性維護，請稍後再試。'
            });
            const [isSystemUnderMaintenance, setIsSystemUnderMaintenance] = useState(false);

            // 用戶端狀態
            const [step, setStep] = useState(1);
            const [formData, setFormData] = useState({
                app: '',
                username: '',
                phone: '',
                email: ''
            });
            const [verificationCode, setVerificationCode] = useState('');
            const [copied, setCopied] = useState(false);
            const [error, setError] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            // 管理員狀態
            const [adminPassword, setAdminPassword] = useState('');
            const [verifications, setVerifications] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            
            // 刪除確認視窗狀態
            const [deleteId, setDeleteId] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const [deleteError, setDeleteError] = useState('');

            // --- Firebase Auth ---
            useEffect(() => {
                const initAuth = async () => {
                    await signInAnonymously(auth);
                };
                initAuth().catch(console.error);
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            // --- 監聽系統設定 (維護模式) ---
            useEffect(() => {
                const settingsDocRef = isCustomConfig 
                    ? doc(db, 'settings', 'global')
                    : doc(db, 'artifacts', appId, 'public', 'data', 'settings_global');

                const unsubscribe = onSnapshot(settingsDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setMaintenance(docSnap.data().maintenance || {
                            enabled: false,
                            startTime: '',
                            endTime: '',
                            message: '系統正在進行例行性維護，請稍後再試。'
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            // --- 判斷是否處於維護期間 ---
            useEffect(() => {
                const checkMaintenance = () => {
                    if (!maintenance.enabled) {
                        setIsSystemUnderMaintenance(false);
                        return;
                    }
                    const now = new Date().getTime();
                    const start = maintenance.startTime ? new Date(maintenance.startTime).getTime() : 0;
                    const end = maintenance.endTime ? new Date(maintenance.endTime).getTime() : Infinity;

                    if (now >= start && (isNaN(end) || now <= end)) {
                        setIsSystemUnderMaintenance(true);
                    } else {
                        setIsSystemUnderMaintenance(false);
                    }
                };
                checkMaintenance();
                const timer = setInterval(checkMaintenance, 60000);
                return () => clearInterval(timer);
            }, [maintenance]);

            // --- 管理員：即時監聽資料 ---
            useEffect(() => {
                if (!user || view !== 'admin') return;

                let collectionRef = isCustomConfig 
                    ? collection(db, 'verifications')
                    : collection(db, 'artifacts', appId, 'public', 'data', 'verifications');

                const q = query(collectionRef);
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    data.sort((a, b) => b.timestamp - a.timestamp);
                    setVerifications(data);
                }, (err) => {
                    console.error("讀取失敗:", err);
                    setDeleteError('讀取失敗：權限不足。請檢查 Firestore Rules。');
                });
                return () => unsubscribe();
            }, [user, view]);

            // --- 應用程式定義 ---
            const apps = [
                { 
                    id: 'messenger', 
                    name: 'Messenger', 
                    color: 'bg-blue-500', 
                    textColor: 'text-blue-500', 
                    fields: ['username'],
                    usernameLabel: '暱稱',
                    icon: <svg viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5"><path d="M12 2C6.48 2 2 6.03 2 11C2 13.66 3.22 16.03 5.16 17.65C5.35 17.81 5.44 18.06 5.4 18.3L5.16 19.66C5.07 20.18 5.62 20.58 6.09 20.33L8.19 19.23C8.39 19.12 8.62 19.1 8.84 19.16C9.85 19.42 10.91 19.56 12 19.56C17.52 19.56 22 15.53 22 10.56C22 5.59 17.52 2 12 2ZM13.81 14.16L11.45 11.66L6.87 14.16C6.63 14.29 6.36 14.02 6.5 13.78L8.85 9.53L11.21 12.03L15.8 9.53C16.04 9.4 16.31 9.67 16.17 9.91L13.81 14.16Z" /></svg>
                },
                { 
                    id: 'line', 
                    name: 'LINE', 
                    color: 'bg-green-500', 
                    textColor: 'text-green-500', 
                    fields: ['username', 'phone'],
                    usernameLabel: '暱稱',
                    icon: <svg viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5"><path d="M19.36 10.58C19.36 5.79 14.86 2 9.77 2C4.69 2 0.53 5.61 0.53 10.58C0.53 14.73 3.66 18.23 7.84 19.03C8.16 19.09 8.37 19.28 8.31 19.64L7.96 21.68C7.91 22.03 8.35 22.38 8.76 22.12L13.38 18.96C13.56 18.84 13.75 18.8 13.97 18.8C18.42 18.45 19.36 14.88 19.36 10.58Z" transform="translate(2 1)" /></svg>
                },
                { 
                    id: 'discord', 
                    name: 'Discord', 
                    color: 'bg-indigo-500', 
                    textColor: 'text-indigo-500', 
                    fields: ['username'],
                    usernameLabel: '暱稱',
                    icon: <svg viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5"><path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.419-2.1568 2.419zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.419-2.1568 2.419z"/></svg>
                },
                { 
                    id: 'instagram', 
                    name: 'Instagram', 
                    color: 'bg-pink-600', 
                    textColor: 'text-pink-600', 
                    fields: ['username'],
                    usernameLabel: '暱稱',
                    icon: <svg viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                },
                { 
                    id: 'google_chat', 
                    name: 'Google Chat', 
                    color: 'bg-emerald-600', 
                    textColor: 'text-emerald-600', 
                    fields: ['username', 'email'],
                    usernameLabel: '暱稱',
                    icon: <svg viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
                },
            ];

            const selectedAppObj = apps.find(a => a.id === formData.app);

            // --- 功能函數 ---
            const updateMaintenanceSettings = async () => {
                try {
                    const settingsDocRef = isCustomConfig 
                        ? doc(db, 'settings', 'global')
                        : doc(db, 'artifacts', appId, 'public', 'data', 'settings_global');
                    await setDoc(settingsDocRef, { maintenance }, { merge: true });
                    alert('維護設定已更新！');
                } catch (e) {
                    console.error("更新設定失敗", e);
                    alert('更新失敗：' + e.message);
                }
            };

            const generateCode = async () => {
                if (isSystemUnderMaintenance) {
                    setError('系統維護中，暫時無法生成驗證碼。');
                    return;
                }
                if (!formData.app) {
                    setError('請選擇一個應用程式');
                    return;
                }
                if (selectedAppObj?.fields.includes('username') && !formData.username.trim()) {
                    setError('請輸入您的暱稱');
                    return;
                }
                if (selectedAppObj?.fields.includes('phone') && !formData.phone.trim()) {
                    setError('請輸入您的綁定號碼');
                    return;
                }
                if (selectedAppObj?.fields.includes('email') && !formData.email.trim()) {
                    setError('請輸入您的電子郵件');
                    return;
                }
                setError('');
                setIsSubmitting(true);

                const characters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; 
                const codeLength = Math.floor(Math.random() * 11) + 10;
                let code = '';
                for (let i = 0; i < codeLength; i++) {
                    code += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                
                if (user) {
                    try {
                        const payload = {
                            ...formData,
                            code: code,
                            timestamp: Date.now(),
                            createdAt: new Date().toLocaleString('zh-TW')
                        };
                        const colRef = isCustomConfig 
                            ? collection(db, 'verifications')
                            : collection(db, 'artifacts', appId, 'public', 'data', 'verifications');
                        await addDoc(colRef, payload);
                        setVerificationCode(code);
                        setStep(2);
                    } catch (e) {
                        console.error("儲存失敗", e);
                        setError('系統連線錯誤，請稍後再試。');
                    }
                } else {
                    setError('資料庫尚未連線，請重新整理');
                }
                setIsSubmitting(false);
            };

            const handleCopy = () => {
                let message = `你好，我是 ${formData.username}。`;
                if (formData.phone) message += `\n我的綁定號碼：${formData.phone}`;
                if (formData.email) message += `\n我的電子郵件：${formData.email}`;
                message += `\n這是我的驗證碼：${verificationCode}`;
                
                const textArea = document.createElement("textarea");
                textArea.value = message;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                } catch (err) {
                    console.error('Copy failed', err);
                }
                document.body.removeChild(textArea);
            };

            const handleReset = () => {
                setFormData({ app: '', username: '', phone: '', email: '' });
                setVerificationCode('');
                setStep(1);
                setCopied(false);
            };

            const handleLogin = () => {
                if (adminPassword === '20120219') {
                    setView('admin');
                    setAdminPassword('');
                } else {
                    alert('密碼錯誤');
                }
            };

            const confirmDelete = (id) => {
                setDeleteId(id);
                setDeleteError('');
            };

            const executeDelete = async () => {
                if (!deleteId) return;
                setIsDeleting(true);
                setDeleteError('');
                try {
                    const docRef = isCustomConfig 
                        ? doc(db, 'verifications', deleteId)
                        : doc(db, 'artifacts', appId, 'public', 'data', 'verifications', deleteId);
                    await deleteDoc(docRef);
                    setDeleteId(null);
                } catch (e) {
                    console.error("刪除失敗", e);
                    setDeleteError(e.message);
                } finally {
                    setIsDeleting(false);
                }
            };

            // --- 畫面渲染 ---

            if (isSystemUnderMaintenance && view !== 'admin' && view !== 'login') {
                return (
                    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4 relative">
                        <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center border-t-4 border-amber-500">
                            <div className="mx-auto bg-amber-100 w-20 h-20 rounded-full flex items-center justify-center mb-6 text-amber-600">
                                <Icons.RefreshCw size={40} className="animate-spin-slow" />
                            </div>
                            <h2 className="text-2xl font-bold text-slate-800 mb-3">系統維護更新中</h2>
                            <p className="text-slate-600 mb-6 leading-relaxed">
                                {maintenance.message || '為了提供更好的服務，我們正在進行系統更新。請稍後再回來驗證。'}
                            </p>
                            {maintenance.endTime && (
                                <div className="inline-block bg-slate-50 px-4 py-2 rounded-lg text-sm text-slate-500 border border-slate-200">
                                    預計結束時間：{new Date(maintenance.endTime).toLocaleString()}
                                </div>
                            )}
                        </div>
                        <div className="fixed bottom-6 right-6 z-50 opacity-80 hover:opacity-100 transition-opacity">
                            <button onClick={() => setView('login')} className="bg-white text-slate-400 hover:text-slate-700 p-3 rounded-full shadow-lg border border-slate-100 transition-all hover:scale-110" title="管理員入口">
                                <Icons.Lock size={20} />
                            </button>
                        </div>
                    </div>
                );
            }

            if (view === 'login') {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
                            <div className="flex justify-center mb-4 text-slate-700">
                                <Icons.Lock size={40} />
                            </div>
                            <h2 className="text-xl font-bold text-center mb-6 text-gray-800">管理員登入</h2>
                            <input
                                type="password"
                                value={adminPassword}
                                onChange={(e) => setAdminPassword(e.target.value)}
                                placeholder="請輸入管理密碼"
                                className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-slate-500 outline-none"
                                onKeyDown={(e) => e.key === 'Enter' && handleLogin()}
                            />
                            <button onClick={handleLogin} className="w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 transition-colors">登入系統</button>
                            <button onClick={() => setView('user')} className="w-full mt-3 text-gray-500 text-sm hover:underline">返回用戶驗證頁面</button>
                        </div>
                    </div>
                );
            }

            if (view === 'admin') {
                const filteredVerifications = verifications.filter(v => 
                    v.username.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    v.code.toLowerCase().includes(searchTerm.toLowerCase())
                );

                return (
                    <div className="min-h-screen bg-gray-100 p-4 md:p-8 relative">
                        {deleteId && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                                <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm animate-fadeIn">
                                    <div className="flex justify-center mb-4 text-red-500 bg-red-50 w-16 h-16 rounded-full items-center mx-auto">
                                        <Icons.AlertCircle size={32} />
                                    </div>
                                    <h3 className="text-lg font-bold text-center text-gray-800 mb-2">確定刪除此筆資料？</h3>
                                    <p className="text-sm text-gray-500 text-center mb-6">此動作無法復原，請確認是否執行。</p>
                                    
                                    {deleteError && (
                                        <div className="bg-red-50 border border-red-200 text-red-600 text-sm p-3 rounded-lg mb-4">
                                            <strong>刪除失敗：</strong><br/>請檢查 Firestore Rules。<br/>錯誤：{deleteError}
                                        </div>
                                    )}

                                    <div className="flex gap-3">
                                        <button onClick={() => setDeleteId(null)} className="flex-1 py-2.5 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200 transition-colors" disabled={isDeleting}>取消</button>
                                        <button onClick={executeDelete} disabled={isDeleting} className="flex-1 py-2.5 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition-colors flex items-center justify-center gap-2">{isDeleting ? '刪除中...' : '確認刪除'}</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="max-w-5xl mx-auto space-y-6">
                            <div className="flex justify-between items-center">
                                <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Icons.ShieldCheck className="text-slate-600" /> 管理員後台</h1>
                                <button onClick={() => setView('user')} className="flex items-center gap-2 text-sm text-red-600 font-medium px-4 py-2 bg-white rounded-lg shadow-sm hover:bg-red-50 border border-red-100"><Icons.LogOut size={16} /> 登出</button>
                            </div>

                            {/* 維護設定 */}
                            <div className="bg-white rounded-2xl shadow-sm border border-amber-200 overflow-hidden">
                                <div className="bg-amber-50 p-4 border-b border-amber-100 flex items-center gap-2">
                                    <Icons.Settings className="text-amber-600" size={20} />
                                    <h2 className="font-bold text-amber-900">系統維護設定</h2>
                                </div>
                                <div className="p-6 grid md:grid-cols-2 gap-6">
                                    <div className="space-y-4">
                                        <div className="flex items-center gap-2 mb-2">
                                            <label className="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" className="sr-only peer" checked={maintenance.enabled} onChange={(e) => setMaintenance({...maintenance, enabled: e.target.checked})} />
                                                <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
                                                <span className="ml-3 text-sm font-medium text-gray-900">啟用維護模式</span>
                                            </label>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">維護公告訊息</label>
                                            <textarea className="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-500 outline-none" rows="2" value={maintenance.message} onChange={(e) => setMaintenance({...maintenance, message: e.target.value})} />
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">開始時間</label>
                                            <input type="datetime-local" className="w-full p-2 border border-gray-300 rounded-lg text-sm" value={maintenance.startTime} onChange={(e) => setMaintenance({...maintenance, startTime: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">預計結束時間</label>
                                            <input type="datetime-local" className="w-full p-2 border border-gray-300 rounded-lg text-sm" value={maintenance.endTime} onChange={(e) => setMaintenance({...maintenance, endTime: e.target.value})} />
                                        </div>
                                    </div>
                                </div>
                                <div className="px-6 pb-6 text-right">
                                    <button onClick={updateMaintenanceSettings} className="bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-amber-700 transition-colors shadow-sm">儲存設定</button>
                                </div>
                            </div>

                            {/* 列表 */}
                            <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                                <div className="p-4 border-b border-gray-100 bg-gray-50 flex flex-col md:flex-row md:items-center justify-between gap-4">
                                    <div className="relative flex-1 max-w-md">
                                        <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><Icons.Search size={18} /></div>
                                        <input type="text" placeholder="搜尋名稱或代碼..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div className="text-sm text-gray-500">共 {verifications.length} 筆資料</div>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="bg-gray-50 text-gray-600 text-sm border-b border-gray-200">
                                                <th className="p-4 font-semibold">時間</th>
                                                <th className="p-4 font-semibold">應用程式</th>
                                                <th className="p-4 font-semibold">用戶資料</th>
                                                <th className="p-4 font-semibold">驗證碼</th>
                                                <th className="p-4 font-semibold text-right">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {filteredVerifications.map((v) => {
                                                const app = apps.find(a => a.id === v.app);
                                                return (
                                                    <tr key={v.id} className="hover:bg-gray-50 transition-colors">
                                                        <td className="p-4 text-sm text-gray-500 whitespace-nowrap">{v.createdAt || new Date(v.timestamp).toLocaleString()}</td>
                                                        <td className="p-4"><span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-white border shadow-sm ${app?.textColor}`}>{app?.icon}{app?.name}</span></td>
                                                        <td className="p-4">
                                                            <div className="font-medium text-gray-900">{v.username}</div>
                                                            <div className="text-xs text-gray-500 space-y-0.5">
                                                                {v.phone && <div className="flex items-center gap-1"><Icons.Phone size={10}/> {v.phone}</div>}
                                                                {v.email && <div className="flex items-center gap-1"><Icons.Mail size={10}/> {v.email}</div>}
                                                            </div>
                                                        </td>
                                                        <td className="p-4"><span className="font-mono font-bold text-slate-700 bg-slate-100 px-2 py-1 rounded border border-slate-200">{v.code}</span></td>
                                                        <td className="p-4 text-right">
                                                            <button onClick={() => confirmDelete(v.id)} className="text-gray-400 hover:text-red-500 transition-colors p-2 rounded-lg hover:bg-red-50" title="刪除"><Icons.Trash2 size={18} /></button>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                            {filteredVerifications.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-gray-400">目前沒有相符的驗證資料</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- 用戶驗證表單 ---
            return (
                <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4 relative">
                    <div className="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                        <div className="bg-slate-800 p-6 text-center">
                            <div className="mx-auto bg-slate-700 w-12 h-12 rounded-full flex items-center justify-center mb-3 text-white">
                                <Icons.ShieldCheck size={28} />
                            </div>
                            <h1 className="text-2xl font-bold text-white tracking-wide">新用戶驗證</h1>
                            <p className="text-slate-400 text-sm mt-1">請完成以下步驟以獲取驗證代碼</p>
                        </div>

                        <div className="p-6">
                            {step === 1 ? (
                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                            <span className="w-6 h-6 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center text-xs">1</span>
                                            選擇您使用的應用程式
                                        </label>
                                        <div className="grid grid-cols-1 gap-3">
                                            {apps.map((app) => (
                                                <button key={app.id} onClick={() => { setFormData({ ...formData, app: app.id, phone: '', email: '' }); setError(''); }} className={`relative flex items-center p-3 rounded-xl border-2 transition-all duration-200 ${formData.app === app.id ? `border-${app.color.replace('bg-', '')} bg-gray-50 ring-1 ring-${app.color.replace('bg-', '')}` : 'border-gray-100 hover:border-gray-300 hover:bg-gray-50'}`}>
                                                    <div className={`p-2 rounded-lg ${app.color} text-white mr-3 shadow-sm`}>{app.icon}</div>
                                                    <span className="font-medium text-gray-700">{app.name}</span>
                                                    {formData.app === app.id && <div className={`absolute right-3 w-5 h-5 rounded-full ${app.color} text-white flex items-center justify-center`}><Icons.Check size={14} /></div>}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className={`transition-all duration-300 ${formData.app ? 'opacity-100' : 'opacity-50 pointer-events-none grayscale'}`}>
                                        <label className="block text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                            <span className="w-6 h-6 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center text-xs">2</span>
                                            填寫驗證資料
                                        </label>
                                        
                                        <div className="space-y-4">
                                            <div className="relative">
                                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icons.User size={18} /></div>
                                                <input type="text" value={formData.username} onChange={(e) => { setFormData({ ...formData, username: e.target.value }); setError(''); }} placeholder={`輸入您的${selectedAppObj?.usernameLabel || '暱稱'}`} disabled={!formData.app} className="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none transition-all" />
                                            </div>

                                            {selectedAppObj?.fields.includes('phone') && (
                                                <div className="relative animate-fadeIn">
                                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icons.Phone size={18} /></div>
                                                    <input type="tel" value={formData.phone} onChange={(e) => { setFormData({ ...formData, phone: e.target.value }); setError(''); }} placeholder="輸入綁定號碼 (例如: 0912345678)" className="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none transition-all" />
                                                </div>
                                            )}

                                            {selectedAppObj?.fields.includes('email') && (
                                                <div className="relative animate-fadeIn">
                                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icons.Mail size={18} /></div>
                                                    <input type="email" value={formData.email} onChange={(e) => { setFormData({ ...formData, email: e.target.value }); setError(''); }} placeholder="輸入電子郵件 (例如: user@gmail.com)" className="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none transition-all" />
                                                </div>
                                            )}
                                        </div>

                                        {formData.app && (
                                            <p className="mt-3 text-xs text-amber-600 flex items-start gap-1 bg-amber-50 p-2 rounded-lg border border-amber-100">
                                                <Icons.MessageSquare size={14} className="mt-0.5 shrink-0" />
                                                請務必輸入您在 {selectedAppObj?.name} 上的正確資料，以便管理員核對。
                                            </p>
                                        )}
                                    </div>

                                    {error && <div className="text-red-500 text-sm font-medium text-center bg-red-50 p-2 rounded-lg animate-pulse">{error}</div>}

                                    <button onClick={generateCode} disabled={isSubmitting} className="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-slate-200 transition-all active:scale-[0.98] flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed">{isSubmitting ? '處理中...' : '產生驗證碼'}</button>
                                </div>
                            ) : (
                                <div className="text-center space-y-6 animate-fadeIn">
                                    <div className="bg-green-50 rounded-2xl p-6 border border-green-100">
                                        <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600"><Icons.Check size={32} /></div>
                                        <h3 className="text-xl font-bold text-gray-800">驗證碼已生成！</h3>
                                        <p className="text-sm text-gray-500 mt-1">請將此代碼傳送給管理員</p>
                                    </div>

                                    <div className="space-y-2">
                                        <div className="text-xs text-gray-400 uppercase tracking-wider font-semibold">您的驗證碼</div>
                                        <div className="bg-slate-800 text-white text-xl md:text-2xl font-mono font-bold py-4 px-4 break-all rounded-xl tracking-widest shadow-inner relative overflow-hidden group">
                                            {verificationCode}
                                            <div className="absolute top-0 -left-[100%] w-1/2 h-full bg-gradient-to-r from-transparent via-white/10 to-transparent skew-x-[-25deg] group-hover:animate-shine" />
                                        </div>
                                    </div>

                                    <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 text-left">
                                        <h4 className="text-sm font-semibold text-gray-700 mb-2">下一步：</h4>
                                        <ul className="text-sm text-gray-600 space-y-2">
                                            <li className="flex gap-2"><span className="font-bold text-slate-400">1.</span> 點擊下方按鈕複製完整資料。</li>
                                            <li className="flex gap-2"><span className="font-bold text-slate-400">2.</span> 前往 <span className={`font-bold ${selectedAppObj?.textColor}`}>{selectedAppObj?.name}</span>。</li>
                                            <li className="flex gap-2"><span className="font-bold text-slate-400">3.</span> 將資料貼上傳送至應用程式聊天室或私訊。</li>
                                        </ul>
                                    </div>

                                    <div className="flex gap-3">
                                        <button onClick={handleReset} className="flex-1 py-3 px-4 border border-gray-200 text-gray-600 font-semibold rounded-xl hover:bg-gray-50 transition-colors flex items-center justify-center gap-2"><Icons.RefreshCw size={18} /> 重新填寫</button>
                                        <button onClick={handleCopy} className={`flex-[2] py-3 px-4 rounded-xl font-bold shadow-md transition-all flex items-center justify-center gap-2 text-white ${copied ? 'bg-green-500 hover:bg-green-600' : 'bg-slate-800 hover:bg-slate-900'}`}>{copied ? <Icons.Check size={18} /> : <Icons.Copy size={18} />} {copied ? '已複製！' : '複製代碼'}</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <div className="fixed bottom-6 right-6 z-50 opacity-80 hover:opacity-100 transition-opacity">
                        <button onClick={() => setView('login')} className="bg-white text-slate-400 hover:text-slate-700 p-3 rounded-full shadow-lg border border-slate-100 transition-all hover:scale-110" title="管理員入口">
                            <Icons.Lock size={20} />
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
